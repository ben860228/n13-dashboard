<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PCM å›å ±ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Load CSS -->
    <!-- Custom CSS (Inlined for reliability) -->
    <style>
        body {
            background-color: #212529;
            color: #f8f9fa;
            padding-bottom: 50px;
        }

        .form-control,
        .form-select {
            background-color: #2c3034;
            border-color: #495057;
            color: #fff;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            font-weight: bold;
        }

        .container {
            margin-top: 20px;
        }

        #status-bar {
            font-size: 12px;
            color: #aaa;
            text-align: center;
            margin-bottom: 10px;
        }

        /* Card View Styles */
        .report-card {
            background-color: #2c3034;
            border: 1px solid #495057;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            position: relative;
        }

        .report-card:active {
            transform: scale(0.98);
            background-color: #343a40;
        }

        .report-card.selected {
            border: 2px solid #0d6efd;
            /* Blue for Prod */
            background-color: #333;
        }

        .report-info {
            font-size: 0.9em;
            color: #adb5bd;
        }

        .report-content {
            font-weight: bold;
            color: #fff;
            margin-top: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .btn-history {
            position: absolute;
            right: 10px;
            top: 10px;
            padding: 4px 8px;
            font-size: 0.8em;
            z-index: 10;
        }

        /* Improved Placeholder Visibility */
        ::placeholder {
            color: #adb5bd !important;
            opacity: 1;
        }

        /* Calculator Styles */
        .calc-weight-bar-bg {
            height: 6px;
            background-color: #495057;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .calc-weight-bar-fill {
            height: 100%;
            background-color: #0dcaf0;
            transition: width 0.3s ease;
        }

        .calc-weight-bar-fill.over {
            background-color: #dc3545;
        }

        .calc-weight-bar-fill.under {
            background-color: #ffc107;
        }

        .calc-weight-bar-fill.exact {
            background-color: #198754;
        }

        .calc-item-card {
            background-color: #383c40;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
            border: 1px solid #4a4e52;
        }

        .calc-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
        }
    </style>

    <!-- Removed BI Link for Stability -->
</head>

<body>

    <div class="container">
        <div id="status-bar">ç³»çµ±è¼‰å…¥ä¸­...</div>

        <h3 class="mb-4 text-center">ğŸ“‹ å°ˆæ¡ˆå›å ±</h3>


        <div id="userInfoBlock" class="alert alert-secondary">
            <span id="userNameDisplay">é©—è­‰èº«åˆ†ä¸­...</span>
        </div>
        <div class="mt-2 mb-3 input-group input-group-sm">
            <span class="input-group-text bg-dark text-secondary border-secondary">å°ˆæ¡ˆ</span>
            <select id="projectSelect" class="form-select form-select-sm" aria-label="Project Select">
                <option value="" selected disabled>è®€å–å°ˆæ¡ˆåˆ—è¡¨...</option>
            </select>
        </div>

        <div id="errorBlock" class="alert alert-danger d-none"></div>

        <!-- NEW: Tab Navigation -->
        <ul class="nav nav-tabs mb-3" id="modeTabs">
            <li class="nav-item">
                <a class="nav-link active" id="tab-new" href="javascript:void(0)" onclick="switchMode('new')">ğŸ“‹
                    æ–°å¢å›å ±</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="tab-edit" href="javascript:void(0)" onclick="switchMode('edit')">âœï¸ ä¿®æ”¹å›å ±</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="tab-progress" href="javascript:void(0)" onclick="switchMode('progress')">ğŸ“ˆ
                    é€±é€²åº¦</a>
            </li>
        </ul>

        <!-- NEW: Edit Mode Selector (Card View) -->
        <div id="edit-selector-container" class="mb-3" style="display: none;">
            <label class="form-label text-info">é¸æ“‡è¦ä¿®æ”¹çš„é …ç›® (æœ€è¿‘ 20 ç­†)</label>
            <div id="reportList" style="max-height: 300px; overflow-y: auto;">
                <div class="text-center text-muted p-3">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- NEW: Weekly Progress Container -->
        <div id="progressBlock" class="d-none mb-5">
            <!-- Date & Filter Header -->
            <div class="card mb-3 bg-dark border-secondary">
                <div class="card-body p-2 d-flex justify-content-between align-items-center">
                    <div class="d-flex flex-column">
                        <span class="text-secondary" style="font-size: 10px;">å›å ±å€é–“ (é€±äº”)</span>
                        <select id="progressDateSelect"
                            class="form-select form-select-sm py-0 bg-dark text-white border-0"
                            style="width: auto; font-weight:bold;">
                            <option>è¼‰å…¥ä¸­...</option>
                        </select>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showAllTasksSwitch"
                            onchange="renderProgressCards()">
                        <label class="form-check-label text-secondary small" for="showAllTasksSwitch">å…¨éƒ¨</label>
                    </div>
                </div>
            </div>

            <!-- Cards Container -->
            <div id="progressList" class="pb-5">
                <div class="text-center text-muted mt-5">è«‹é¸æ“‡å°ˆæ¡ˆä»¥è¼‰å…¥é€²åº¦</div>
            </div>

            <!-- Floating Action Button Area -->
            <div class="fixed-bottom p-3"
                style="background: linear-gradient(transparent 10%, #212529 40%); pointer-events: none;">
                <button id="btnSubmitProgress" class="btn btn-primary w-100 shadow-lg fw-bold p-3"
                    style="pointer-events: auto; display:none;" onclick="submitProgressBatch()">
                    ğŸš€ é€å‡ºæ›´æ–° (<span id="progress-update-count">0</span>)
                </button>
            </div>
        </div>

        <!-- NEW: Calculator Modal -->
        <div class="modal fade" id="calcModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-dark text-white border-secondary">
                    <div class="modal-header border-secondary p-2">
                        <h5 class="modal-title fs-6" id="calcModalTitle">å€‹äººè¨ˆç®—æ©Ÿ</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-2">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small text-muted">æ¬Šé‡åˆ†é…</span>
                            <button class="btn btn-sm btn-outline-info py-0" onclick="addCalcItem()">+ æ–°å¢å­é …ç›®</button>
                        </div>

                        <div id="calcItemsList" style="max-height: 250px; overflow-y: auto;">
                            <!-- items -->
                        </div>

                        <div class="border-top border-secondary mt-3 pt-2">
                            <div class="d-flex justify-content-between small mb-1">
                                <span>ç¸½æ¬Šé‡: <span id="calcTotalWeight" class="fw-bold">0</span>%</span>
                                <span id="calcWeightWarning" class="text-danger" style="display:none;">(é 100%)</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fs-5">æœ¬é€±ç¸½é€²åº¦:</span>
                                <span class="fs-4 fw-bold text-success"><span id="calcResult">0</span>%</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary p-2">
                        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-sm btn-primary" onclick="applyCalcResult()">å¥—ç”¨ä¸¦å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>



        <!-- Success Block (Static, Hidden by Default) -->
        <div id="successBlock" class="text-center mt-5 p-4 d-none">
            <div class="mb-4" style="font-size: 80px;">âœ…</div>
            <h2 id="successMsg" class="text-white mb-4 fw-bold">è™•ç†æˆåŠŸ</h2>
            <p class="text-secondary mb-5 fs-5">è³‡æ–™å·²æˆåŠŸå¯«å…¥è³‡æ–™åº«</p>

            <div class="d-grid gap-3 col-10 mx-auto">
                <button type="button" class="btn btn-outline-light btn-lg" onclick="resetForm()">
                    <span id="successBtnText">å†æ¬¡å›å ±</span>
                </button>
            </div>

            <div class="mt-4 text-muted small">
                JingYi Tech System
            </div>
        </div>

        <!-- Main Form Block -->
        <div id="formBlock">
            <div id="bulletinForm" class="needs-validation">

                <!-- Hidden Fields -->
                <input type="hidden" id="userId" name="userId">
                <input type="hidden" id="lineUserId" name="lineUserId">
                <input type="hidden" id="uuid" name="uuid"> <!-- NEW: UUID for Edit -->

                <!-- Project (Moved to Top) -->
                <!-- Removed duplicate selector -->

                <!-- Date -->
                <div class="mb-3">
                    <label for="dateInput" class="form-label fw-bold">æ—¥æœŸ</label>
                    <input type="date" class="form-control" id="dateInput" required>
                </div>

                <!-- Type -->
                <div class="mb-3">
                    <label for="typeSelect" class="form-label fw-bold">é¡å‹</label>
                    <select class="form-select" id="typeSelect" required>
                        <option value="é€²åº¦å›å ±" selected>é€²åº¦å›å ±</option>
                        <option value="æœƒè­°è¨˜éŒ„">æœƒè­°è¨˜éŒ„</option>
                    </select>
                </div>

                <!-- Category Block -->
                <div class="mb-3" id="catBlock">
                    <label for="categorySelect" class="form-label fw-bold">åˆ†é¡ (å­åˆ†é¡)</label>
                    <select class="form-select" id="categorySelect">
                        <option value="è¡Œæ”¿" selected>è¡Œæ”¿</option>
                        <option value="è¨­è¨ˆ">è¨­è¨ˆ</option>
                        <option value="æ–½å·¥">æ–½å·¥</option>
                    </select>
                </div>

                <!-- Task Block -->
                <div class="mb-3" id="taskBlock">
                    <label for="taskSelect" class="form-label fw-bold">å·¥ä½œé …ç›®</label>
                    <!-- Default select, will be replaced by script if loading fails or loaded -->
                    <select class="form-select" id="taskSelect">
                        <option value="" disabled selected>è®€å–ä¸­...</option>
                    </select>
                    <div class="form-text text-muted" id="taskHint">
                        è‹¥ç„¡å°æ‡‰å·¥é …å¯é¸ã€Œå…¶ä»–ã€æˆ–æ‰‹å‹•è¼¸å…¥
                    </div>
                </div>


                <!-- Content -->
                <div class="mb-4">
                    <label for="contentInput" class="form-label fw-bold">å…§å®¹</label>
                    <textarea class="form-control" id="contentInput" rows="5" required
                        placeholder="è«‹è¼¸å…¥å›å ±å…§å®¹..."></textarea>
                </div>

                <!-- Helper text -->
                <div class="mb-3 d-flex justify-content-center align-items-center position-relative">
                    <small class="text-muted" id="status-bar-bottom">æº–å‚™å°±ç·’</small>
                    <span class="position-absolute end-0" onclick="toggleDebug()"
                        style="cursor: pointer; opacity: 0.3; font-size: 1.2rem;">â„¹ï¸</span>
                </div>

                <!-- Submit Btn -->
                <div class="d-grid gap-2">
                    <button type="button" id="submitBtn" class="btn btn-primary btn-lg fw-bold shadow-sm">
                        ç™¼ä½ˆ
                    </button>
                    <!-- Delete Button for Edit Mode -->
                    <!-- åˆªé™¤æŒ‰éˆ• (é è¨­éš±è—) -->
                    <button type="button" id="deleteBtn" class="btn btn-outline-danger w-100 mt-2" style="display:none;"
                        onclick="confirmDelete()">
                        ğŸ—‘ï¸ åˆªé™¤æ­¤å›å ±
                    </button>
                </div>

                <!-- DEBUG CONSOLE (Hidden by default) -->
                <div class="mt-4 p-2 bg-dark text-warning font-monospace" id="debug-console"
                    style="display: none; font-size: 10px; opacity: 0.8; height: 100px; overflow-y: scroll;">
                    System Ready.
                </div>
            </div>
        </div>

        <!-- Confirm Delete Modal (Bootstrap) - Moved out to Body Level -->
        <div class="modal" id="deleteConfirmModal" tabindex="-1" aria-hidden="true" style="z-index: 1055;">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-dark border-secondary text-white">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title text-danger">âš ï¸ åˆªé™¤ç¢ºèª</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        ç¢ºå®šè¦åˆªé™¤æ­¤å›å ±å—ï¼Ÿ<br>
                        <span class="text-secondary small">(æ­¤å‹•ä½œç„¡æ³•å¾©åŸ)</span>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-danger" onclick="executeDelete()">ç¢ºèªåˆªé™¤</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

        <!-- Global Config (Must be here for server-side injection) -->
        <script>
            const LIFF_ID = "2008698380-xwXH3g1t";
            const MAGIC_UID = "<?= serverUid ?>";
            const TASKS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQiyY2STxHEAcJIa_wBeLHRYpGj82dozn-1tCo_ZhltPo-CABMaWOD88K7LLJnXTtW_3IV-k2qZq8HV/pub?gid=0&single=true&output=csv";
        </script>

        <!-- Load JS -->
        <?!= include('line_form_js'); ?>
        <?!= include('line_form_progress_js'); ?>

</body>

</html>