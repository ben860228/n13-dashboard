<script>
    // Global Error Handler
    window.onerror = function (msg, url, line, col, error) {
        debugLog("JS Error: " + msg + " (L" + line + ")");
        return false;
    };

    function debugLog(msg) {
        const c = document.getElementById('debug-console');
        if (c) {
            const t = new Date().toLocaleTimeString();
            c.innerHTML += `<div>[${t}] ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }
        // Also console for verification
        console.log(msg);
    }

    function updateStatus(msg) {
        const bar = document.getElementById('status-bar');
        if (bar) bar.innerText = msg;
    }

    function toggleDebug() {
        const c = document.getElementById('debug-console');
        if (c.style.display === 'none') {
            c.style.display = 'block';
        } else {
            c.style.display = 'none';
        }
    }

    // Globals are now defined in main file
    // Global Tasks Storage
    let g_allTasks = [];
    let myReportsCache = [];
    let currentMode = 'new'; // 'new' | 'edit'

    // æ›´ç²—æš´ç›´æ¥çš„ç’°å¢ƒåˆ¤æ–· (ä¸ä¾è³´ LIFF init)
    const isLineClient = navigator.userAgent.includes('Line') || navigator.userAgent.includes('LINB');

    document.addEventListener("DOMContentLoaded", function () {
        try {
            // Init UI
            document.getElementById('dateInput').valueAsDate = new Date();

            // Call the setup logic (now global)
            setupFormLogic();

            // Debug Info
            let debugMsg = "Load: ";
            if (MAGIC_UID) debugMsg += "UIDlen=" + MAGIC_UID.length;
            else debugMsg += "NoUID";
            debugLog(debugMsg);

            // Simple Robust Check
            const hasServerUid = MAGIC_UID &&
                MAGIC_UID.trim() !== "" &&
                !MAGIC_UID.includes("serverUid");

            if (hasServerUid) {
                updateStatus("ğŸŸ¢ è®€å–é€£çµè³‡æ–™ä¸­...");
                fetchConfig(MAGIC_UID);
                initLiffSilently();
            } else {
                debugLog("Fallback to LIFF Login");
                updateStatus("ğŸŸ  æ­£åœ¨é©—è­‰èº«åˆ†...");
                tryLiffLogin();
            }
        } catch (e) {
            console.error(e);
            debugLog("InitErr: " + e.message);
            alert("åˆå§‹åŒ–éŒ¯èª¤: " + e.message);
        }
    });

    // --- GLOBAL FUNCTIONS START ---
    // Moved out of DOMContentLoaded to ensure HTML onclick attributes work

    // é»˜é»˜åˆå§‹åŒ– LIFF ä¸”ä¸åŸ·è¡Œç™»å…¥ (åªç‚ºäº†æ‹¿åŠŸèƒ½)
    function initLiffSilently() {
        if (typeof liff !== 'undefined') {
            liff.init({ liffId: LIFF_ID }).catch(err => console.log('Silent Init Error', err));
        }
    }

    function tryLiffLogin() {
        if (typeof liff === 'undefined') {
            debugLog("LIFF SDK Missing");
            showError("ç„¡æ³•è¼‰å…¥ LINE å…ƒä»¶ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ˜¯é‡æ–°é–‹å•Ÿ");
            return;
        }

        debugLog("LIFF Init Start...");
        // Timeout Race
        const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("Init Config Timeout")), 10000));

        Promise.race([
            liff.init({ liffId: LIFF_ID }),
            timeout
        ]).then(() => {
            debugLog("LIFF Init OK. LoggedIn: " + liff.isLoggedIn());
            if (!liff.isLoggedIn()) {
                debugLog("Not Logged In -> redirect to login");
                liff.login();
            } else {
                liff.getProfile().then(profile => {
                    debugLog("Profile: " + profile.userId);
                    fetchConfig(profile.userId);
                }).catch(e => {
                    debugLog("Profile Error: " + e.message);
                    showError("ç„¡æ³•å–å¾—ç”¨æˆ¶è³‡æ–™: " + e.message);
                });
            }
        }).catch(err => {
            debugLog("LIFF Init Fail: " + err.message);
            showError("èº«åˆ†é©—è­‰å¤±æ•— (Init): " + err.message + "\nè«‹åœ¨èŠå¤©å®¤è¼¸å…¥ã€Œå›å ±ã€é‡æ–°å–å¾—é€£çµ");
        });
    }

    // Global User ID Cache
    let g_currentUserId = "";

    function fetchConfig(userId) {
        g_currentUserId = userId; // Cache it
        const uidField = document.getElementById('lineUserId');
        const uidField2 = document.getElementById('userId');
        if (uidField) uidField.value = userId;
        if (uidField2) uidField2.value = userId;

        debugLog("Fetching config for: " + userId);

        google.script.run
            .withSuccessHandler(onConfigLoaded)
            .withFailureHandler(onFailure)
            .getLiffConfig(userId);
    }

    function onConfigLoaded(configStr) {
        let config;
        try {
            debugLog("Config Raw: " + configStr);
            config = JSON.parse(configStr);
        } catch (e) {
            config = { success: false, message: "JSON Parse Error: " + e.message };
        }

        if (config.error || !config.success) {
            showError((config.message || "èº«åˆ†é©—è­‰å¤±æ•—ï¼Œè«‹ç¢ºèªç¶å®šç‹€æ…‹"));
            return;
        }

        debugLog("Config Parsed OK. User: " + config.userName);

        // Update UI with User Info
        document.getElementById('userInfoBlock').classList.remove('alert-secondary');
        document.getElementById('userInfoBlock').classList.add('alert-info');
        document.getElementById('userNameDisplay').innerText = `ä½ å¥½ï¼Œ${config.userName}`;

        // Fill Project Select
        const pSelect = document.getElementById('projectSelect');
        pSelect.innerHTML = "";
        let firstProjectId = "";

        // Hint Option
        pSelect.add(new Option("è«‹é¸æ“‡å°ˆæ¡ˆ...", ""));
        pSelect.options[0].disabled = true;
        pSelect.options[0].selected = true;

        if (config.projects && config.projects.length > 0) {
            config.projects.forEach((p, idx) => {
                let opt = document.createElement("option");
                opt.text = p.name;
                opt.value = p.id;
                pSelect.add(opt);
                if (idx === 0) firstProjectId = p.id;
            });

            // Auto-select first project for convenience
            if (firstProjectId) {
                pSelect.value = firstProjectId;
                // Initial Load triggers
                if (currentMode === 'progress') {
                    fetchProgressData(firstProjectId);
                } else if (currentMode === 'edit') {
                    fetchMyReports(firstProjectId);
                }
                // Always load form tasks
                loadProjectTasks(firstProjectId);
            }

            pSelect.addEventListener('change', function () {
                const pid = this.value;
                if (!pid) return;

                // Reset Data Logic - IMPORTANT for project switching
                g_progressTasks = [];
                g_progressDates = [];

                if (currentMode === 'progress') {
                    // Clear current view first to avoid confusion
                    document.getElementById('progressList').innerHTML = '<div class="text-center p-5 text-muted">è¼‰å…¥ä¸­...</div>';
                    fetchProgressData(pid);
                } else if (currentMode === 'edit') {
                    fetchMyReports(pid);
                }

                // Always reload form tasks for consistency
                loadProjectTasks(pid);
            });

        } else {
            pSelect.innerHTML = '<option disabled>ç„¡å¯ç”¨å°ˆæ¡ˆ</option>';
        }

        if (config.isBoss) {
            const typeSelect = document.getElementById('typeSelect');
            let exists = Array.from(typeSelect.options).some(o => o.value === 'ä¸»ç®¡è¨Šæ¯');
            if (!exists) typeSelect.add(new Option("ä¸»ç®¡è¨Šæ¯", "ä¸»ç®¡è¨Šæ¯"));
        }

        updateStatus("ğŸŸ¢ å°±ç·’");
    }

    function loadProjectTasks(projectId) {
        const tSelect = document.getElementById('taskSelect');
        const taskBlock = document.getElementById('taskBlock');

        tSelect.innerHTML = '<option disabled selected>è®€å–ä¸­ (ç´„éœ€ 10 ç§’)...</option>';
        if (tSelect.tagName === 'INPUT') {
            const newSelect = document.createElement('select');
            newSelect.id = 'taskSelect';
            newSelect.className = 'form-select';
            tSelect.parentNode.replaceChild(newSelect, tSelect);
        }

        const currentType = document.getElementById('typeSelect').value;
        if (currentType === 'é€²åº¦å›å ±') {
            taskBlock.classList.remove('d-none');
        }

        let isResolved = false;

        const fallbackTimer = setTimeout(() => {
            if (!isResolved) {
                isResolved = true;
                const tContainer = document.getElementById('taskSelect').parentNode;
                const input = document.createElement('input');
                input.type = 'text';
                input.id = 'taskSelect';
                input.className = 'form-control';
                input.placeholder = 'è®€å–é€¾æ™‚ï¼Œè«‹ç›´æ¥è¼¸å…¥å·¥é …åç¨±...';

                const oldEl = document.getElementById('taskSelect');
                tContainer.replaceChild(input, oldEl);
            }
        }, 15000);

        try {
            if (typeof google !== 'undefined' && google.script) {
                google.script.run
                    .withSuccessHandler(rawResult => {
                        if (isResolved) return;

                        let result;
                        try { result = JSON.parse(rawResult); } catch (e) { console.error(e); }

                        if (!result || !result.success || !result.tasks) {
                            console.warn("Backend load empty", result);
                            loadTasksFromCSV(tSelect, fallbackTimer);
                            return;
                        }

                        isResolved = true;
                        clearTimeout(fallbackTimer);
                        g_allTasks = result.tasks.map(t => ({
                            name: t.name,
                            category: t.category,
                            pStart: t.planStart ? new Date(t.planStart) : null,
                            pEnd: t.planEnd ? new Date(t.planEnd) : null,
                            aStart: t.actStart ? new Date(t.actStart) : null,
                            aEnd: t.actEnd ? new Date(t.actEnd) : null
                        }));
                        renderTaskOptions();
                    })
                    .withFailureHandler(err => {
                        console.error("Backend failed", err);
                        loadTasksFromCSV(tSelect, fallbackTimer);
                    })
                    .getProjectTasks(projectId);
            } else {
                throw new Error("Local Environment");
            }
        } catch (e) {
            loadTasksFromCSV(tSelect, fallbackTimer);
        }
    }

    function loadTasksFromCSV(tSelect, fallbackTimer) {
        Papa.parse(TASKS_CSV_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
                if (isResolved) return;
                isResolved = true;
                clearTimeout(fallbackTimer);

                const rows = results.data;
                g_allTasks = [];

                if (!rows || rows.length === 0) {
                    tSelect.innerHTML = '<option disabled>æŸ¥ç„¡æ•¸æ“š</option>';
                    return;
                }

                rows.forEach(r => {
                    const name = r['ä»»å‹™åç¨±'] || r['TaskName'] || r['Name'];
                    if (!name) return;
                    const category = r['åˆ†é¡'] || r['Category'] || '';

                    // Simple Date Parse
                    const pStart = (r['é–‹å§‹æ™‚é–“'] || r['Start']) ? new Date(r['é–‹å§‹æ™‚é–“'] || r['Start']) : null;
                    const pEnd = (r['çµæŸæ—¥æœŸ'] || r['End']) ? new Date(r['çµæŸæ—¥æœŸ'] || r['End']) : null;
                    const aStart = (r['å¯¦éš›é–‹å§‹æ™‚é–“'] || r['ActualStart']) ? new Date(r['å¯¦éš›é–‹å§‹æ™‚é–“'] || r['ActualStart']) : null;
                    const aEnd = (r['å¯¦éš›å®Œæˆæ™‚é–“'] || r['ActualEnd']) ? new Date(r['å¯¦éš›å®Œæˆæ™‚é–“'] || r['ActualEnd']) : null;

                    g_allTasks.push({ name, category, pStart, pEnd, aStart, aEnd });
                });

                renderTaskOptions();
            },
            error: function (err) {
                console.error(err);
                tSelect.innerHTML = '<option disabled>è®€å–å¤±æ•—</option>';
                debugLog("CSV è®€å–å¤±æ•—: " + (err.message || err));
            }
        });
    }

    function renderTaskOptions() {
        const tSelect = document.getElementById('taskSelect');
        if (!tSelect || tSelect.tagName !== 'SELECT') return;

        const catSelect = document.getElementById('categorySelect');
        const selectedCat = catSelect ? catSelect.value : '';

        let filteredTasks = g_allTasks;
        if (selectedCat) {
            filteredTasks = g_allTasks.filter(t => t.category === selectedCat);
        }

        tSelect.innerHTML = '<option value="">ç‹€æ…‹å›å ± (ç„¡ç‰¹å®šå·¥é …)</option>';

        if (filteredTasks.length === 0) {
            if (g_allTasks.length > 0) {
                let opt = document.createElement("option");
                opt.disabled = true;
                opt.text = "(æ­¤åˆ†é¡ä¸‹ç„¡å·¥é …)";
                tSelect.add(opt);
            } else {
                tSelect.innerHTML = '<option disabled>è¼‰å…¥ä¸­...</option>';
            }
            return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const groupOverdue = [];
        const groupOngoing = [];
        const groupUpcoming = [];
        const groupDone = [];
        const groupOthers = [];

        filteredTasks.forEach(t => {
            const { name, pStart, pEnd, aStart, aEnd } = t;

            if (aEnd) { groupDone.push(t); return; }

            const isLateFinish = pEnd && today > pEnd;
            const isLateStart = pStart && today > pStart && !aStart;

            if (isLateFinish || isLateStart) { groupOverdue.push(t); return; }
            if (aStart && !aEnd) { groupOngoing.push(t); return; }
            if (pStart && pStart > today) { groupUpcoming.push(t); return; }
            groupOthers.push(t);
        });

        const appendGroup = (label, list) => {
            if (list.length === 0) return;
            const grp = document.createElement('optgroup');
            grp.label = label;
            list.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.name;
                opt.text = t.name;
                grp.appendChild(opt);
            });
            tSelect.appendChild(grp);
        };

        appendGroup("ğŸ”´ ğŸ”´ ç•°å¸¸ / é€¾æœŸ", groupOverdue);
        appendGroup("ğŸ”µ é€²è¡Œä¸­", groupOngoing);
        appendGroup("ğŸŸ¡ å³å°‡é–‹å§‹", groupUpcoming);
        appendGroup("ğŸŸ¢ å·²å®Œæˆ", groupDone);
        appendGroup("âšª å…¶ä»–", groupOthers);
    }

    function resetForm() {
        // 1. Hide Success
        document.getElementById('successBlock').classList.add('d-none');

        // 2. Clear Form Fields
        document.getElementById('contentInput').value = '';
        document.getElementById('taskSelect').value = '';

        // 3. Restore UI Elements
        const tabs = document.getElementById('modeTabs');
        if (tabs) tabs.style.display = 'flex'; // Restore Tabs

        const btn = document.getElementById('submitBtn');
        btn.disabled = false;
        btn.innerText = (currentMode === 'edit') ? "ç¢ºèªä¿®æ”¹" : "ç™¼ä½ˆ";

        // 4. Force Switch to Current Mode (Reset UI & Selector visibility)
        switchMode(currentMode);
        if (currentMode === 'edit') {
            const pid = document.getElementById('projectSelect').value;
            if (pid) fetchMyReports(pid);
        }
    }

    function switchMode(mode) {
        currentMode = mode;
        const formContainer = document.getElementById('formBlock');
        const userInfoBlock = document.getElementById('userInfoBlock');
        const statusBar = document.getElementById('status-bar');
        const progressBlock = document.getElementById('progressBlock'); // NEW

        document.getElementById('successBlock').classList.add('d-none');

        // Toggle Main Views
        if (mode === 'progress') {
            formContainer.classList.add('d-none');
            progressBlock.classList.remove('d-none');
            // Auto Load if project selected
            const pid = document.getElementById('projectSelect').value;
            if (pid) fetchProgressData(pid);
        } else {
            formContainer.classList.remove('d-none');
            progressBlock.classList.add('d-none');
        }

        if (!document.getElementById('errorBlock').innerText) {
            userInfoBlock.classList.remove('d-none');
        }
        if (statusBar) statusBar.style.display = 'block';

        document.querySelectorAll('#modeTabs .nav-link').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + mode).classList.add('active');

        const submitBtn = document.getElementById('submitBtn');
        const editSelector = document.getElementById('edit-selector-container');

        if (mode === 'edit') {
            editSelector.style.display = 'block';
            submitBtn.innerText = 'ç¢ºèªä¿®æ”¹';
            const pid = document.getElementById('projectSelect').value;
            if (pid) fetchMyReports(pid);
        } else {
            editSelector.style.display = 'none';

            if (mode === 'new') {
                submitBtn.innerText = 'ç™¼ä½ˆ';
                submitBtn.className = 'btn btn-primary w-100'; // Reset Class
                // Restore Handler
                if (typeof handleBulletinSubmit === 'function') {
                    submitBtn.onclick = handleBulletinSubmit;
                }

                document.getElementById('uuid').value = '';
                document.getElementById('contentInput').value = '';
                document.getElementById('dateInput').valueAsDate = new Date();

                // Hide Delete
                const delBtn = document.getElementById('deleteBtn');
                if (delBtn) delBtn.style.display = 'none';

            } else if (mode === 'progress') {
                // Progress mode uses its own submit button logic
            }
        }
    }

    // New Delete Logic (Modal Version)
    function confirmDelete() {
        // debugLog("Delete Requested");
        const pid = document.getElementById('projectSelect').value;
        const uid = document.getElementById('lineUserId').value;
        const uuid = document.getElementById('uuid').value;

        if (!pid || !uid || !uuid) {
            alert("è³‡æ–™ä¸å®Œæ•´ï¼Œç„¡æ³•åˆªé™¤ (Missing IDs)");
            return;
        }

        // Show Bootstrap Modal
        var myModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        myModal.show();
    }

    function executeDelete() {
        const pid = document.getElementById('projectSelect').value;
        const uid = document.getElementById('lineUserId').value;
        const uuid = document.getElementById('uuid').value;
        const btn = document.getElementById('deleteBtn');

        // Close Modal
        const el = document.getElementById('deleteConfirmModal');
        const modal = bootstrap.Modal.getInstance(el);
        if (modal) modal.hide();

        updateStatus("ğŸ”´ æ­£åœ¨åˆªé™¤...");
        if (btn) btn.disabled = true;

        google.script.run
            .withSuccessHandler(res => {
                const r = JSON.parse(res);
                if (r.success) {
                    // Replaced alert/reset with Success UI
                    showSuccessUI("âœ… åˆªé™¤æˆåŠŸï¼");
                } else {
                    alert("åˆªé™¤å¤±æ•—: " + r.message);
                    if (btn) btn.disabled = false;
                }
                updateStatus("ğŸŸ¢ å°±ç·’");
            })
            .withFailureHandler(err => {
                alert("ç³»çµ±éŒ¯èª¤: " + err.message);
                if (btn) btn.disabled = false;
                updateStatus("ğŸ”´ éŒ¯èª¤");
            })
            .deleteBulletin({ projectId: pid, lineUserId: uid, uuid: uuid });
    }

    function fetchMyReports(projectId) {
        const uid = document.getElementById('lineUserId').value;
        if (!uid) { return; }

        const listDiv = document.getElementById('reportList');
        listDiv.innerHTML = '<div class="text-center text-warning p-3">è³‡æ–™è¼‰å…¥ä¸­...</div>';

        google.script.run
            .withSuccessHandler(responseStr => {
                let response;
                try { response = JSON.parse(responseStr); } catch (e) {
                    response = { success: false, message: "JSON Parse Fail" };
                }
                if (response.success) {
                    myReportsCache = response.posts;
                    renderReportOptions(response.posts);
                } else {
                    listDiv.innerHTML = '<div class="text-center text-danger">è¼‰å…¥å¤±æ•—: ' + response.message + '</div>';
                }
            })
            .withFailureHandler(err => {
                listDiv.innerHTML = '<div class="text-center text-danger p-3">è¼‰å…¥å¤±æ•—: ' + err.message + '</div>';
            })
            .getMyRecentBulletins({ projectId: projectId, lineUserId: uid });
    }

    function renderReportOptions(posts) {
        try {
            const listDiv = document.getElementById('reportList');
            if (!listDiv) return;
            listDiv.innerHTML = '';

            if (!posts || posts.length === 0) {
                listDiv.innerHTML = '<div class="text-center text-muted p-3">æ²’æœ‰è¿‘æœŸå›å ±ç´€éŒ„</div>';
                return;
            }

            posts.forEach((p, index) => {
                const card = document.createElement('div');
                card.className = 'report-card';
                card.onclick = (e) => {
                    if (e.target.tagName === 'BUTTON') return;
                    document.querySelectorAll('.report-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    loadReportData(index);
                };

                let contentPreview = (p.content || "").substring(0, 50);
                let dateStr = "??-??";
                if (p.date && typeof p.date === 'string' && p.date.length >= 10) {
                    dateStr = p.date.slice(5);
                } else if (p.date) dateStr = String(p.date);

                let typeLabel = p.type || "æœªåˆ†é¡";
                let itemLabel = p.item ? `[${p.item}] ` : "";

                let html = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="report-info">
                        <span class="badge bg-secondary me-1">${dateStr}</span>
                        <span class="text-info">${typeLabel}</span>
                    </div>
                </div>
                <div class="report-content">
                    ${itemLabel} ${contentPreview}
                </div>
            `;
                card.innerHTML = html;
                listDiv.appendChild(card);
            });
        } catch (e) {
            console.error("Render Error:", e);
        }
    }

    function loadReportData(index) {
        if (index === "" || index === "loading") return;
        const data = myReportsCache[index];
        if (!data) {
            debugLog("Load Data Fail: Index " + index + " not found");
            return;
        }

        debugLog("Loading Report: " + index + ", UUID=" + data.uuid); // Critical Debug

        const uuidField = document.getElementById('uuid');
        uuidField.value = data.uuid || ""; // Ensure empty string if undefined

        if (!uuidField.value) {
            debugLog("WARNING: UUID is empty in data source!");
            alert("è­¦å‘Šï¼šæ­¤é …ç›®è³‡æ–™ç•°å¸¸ (ç¼ºå°‘ UUID)ï¼Œç„¡æ³•é€²è¡Œä¿®æ”¹ã€‚\nè«‹å˜—è©¦é¸æ“‡å…¶ä»–é …ç›®æˆ–æ˜¯è¯ç¹«ç®¡ç†å“¡ã€‚");
        }

        document.getElementById('dateInput').value = data.date;
        document.getElementById('typeSelect').value = data.type;
        document.getElementById('categorySelect').value = data.category;

        // Scroll to Form Top (RESTORED FIX)
        const formBlock = document.getElementById('formBlock');
        if (formBlock) {
            const y = formBlock.getBoundingClientRect().top + window.scrollY - 60;
            window.scrollTo({ top: y, behavior: 'smooth' });
        }

        // Trigger Type Logic
        const newTypeSelect = document.getElementById('typeSelect');
        newTypeSelect.dispatchEvent(new Event('change'));

        // Trigger Category Logic
        const catSelect = document.getElementById('categorySelect');
        catSelect.dispatchEvent(new Event('change'));

        // Show Delete Button
        const delBtn = document.getElementById('deleteBtn');
        if (delBtn) {
            delBtn.style.display = 'block';
            delBtn.onclick = confirmDelete; // Explicit binding
        }

        setTimeout(() => {
            const tSelect = document.getElementById('taskSelect');
            if (tSelect.tagName === 'SELECT') {
                if (data.item) {
                    let exists = Array.from(tSelect.options).some(o => o.value === data.item);
                    if (!exists) tSelect.add(new Option(data.item, data.item));
                    tSelect.value = data.item;
                }
            } else {
                tSelect.value = data.item;
            }
        }, 500);

        document.getElementById('contentInput').value = data.content;
    }

    // --- CALCULATOR LOGIC ---
    let g_currentCalcTask = "";
    // Refactored Data Structure: { items: [], memo: "" }
    let g_calcData = { items: [], memo: "" };

    function openCalc(taskName) {
        g_currentCalcTask = taskName;

        // New Header Structure
        const headerHtml = `
            <div class="w-100">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="h5 mb-0">å­é …ç›®è¨ˆç®—æ©Ÿ</span>
                </div>
                <div class="text-info small mt-1 text-truncate">${taskName}</div>
                <div class="calc-weight-bar-bg" title="æ¬Šé‡åˆ†é…é€²åº¦">
                    <div id="calcWeightBar" class="calc-weight-bar-fill" style="width: 0%"></div>
                </div>
                <!-- Memo Section -->
                <div class="mt-2">
                    <textarea id="calcMemo" class="form-control form-control-sm bg-dark text-white border-secondary" 
                        rows="2" placeholder="å‚™è¨»éš¨ç­† (Memo)..." onchange="updateCalcMemo(this.value)"></textarea>
                </div>
            </div>
        `;
        document.getElementById('calcModalTitle').innerHTML = headerHtml;

        // Fetch saved breakdown
        const listDiv = document.getElementById('calcItemsList');
        listDiv.innerHTML = '<div class="text-center p-3">è®€å–ä¸­...</div>';

        // Clear Footer Totals temporarily
        document.getElementById('calcTotalWeight').innerText = "0";
        document.getElementById('calcResult').innerText = "0.0";
        document.getElementById('calcWeightWarning').style.display = 'none';

        const pid = document.getElementById('projectSelect').value;
        var modal = new bootstrap.Modal(document.getElementById('calcModal'));
        modal.show();

        google.script.run
            .withSuccessHandler(res => {
                const r = JSON.parse(res);
                if (r.success && r.data) {
                    try {
                        const parsed = JSON.parse(r.data);
                        // Migration Logic: Array -> Object
                        if (Array.isArray(parsed)) {
                            g_calcData = { items: parsed, memo: "" };
                        } else {
                            g_calcData = parsed || { items: [], memo: "" };
                        }
                    } catch (e) { g_calcData = { items: [], memo: "" }; }
                } else {
                    g_calcData = { items: [], memo: "" };
                }

                // Render Memo
                const memoEl = document.getElementById('calcMemo');
                if (memoEl) memoEl.value = g_calcData.memo || "";
                renderCalcItems();
            })
            .getTaskBreakdown(pid, taskName);
    }

    function renderCalcItems() {
        const list = document.getElementById('calcItemsList');
        list.innerHTML = "";
        let totalWeight = 0;
        let totalProg = 0;

        // Safety check
        if (!g_calcData.items) g_calcData.items = [];
        const items = g_calcData.items;

        if (items.length === 0) {
            addCalcItem(); // Ensure at least one
            return; // addCalcItem calls render
        }

        items.forEach((item, idx) => {
            const w = parseFloat(item.weight) || 0;
            totalWeight += w;
            const p = parseFloat(item.progress) || 0;
            totalProg += (w * p / 100);

            const row = document.createElement('div');
            row.className = "calc-item-card";
            row.innerHTML = `
                <button class="btn btn-sm text-danger border-0 calc-delete-btn fs-5" onclick="removeCalcItem(${idx})" title="åˆªé™¤æ­¤é …">
                    &times;
                </button>
                <div class="mb-2 pe-4">
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                        placeholder="è¼¸å…¥å­é …ç›®åç¨±..." value="${item.name}" 
                        onchange="updateCalcItem(${idx}, 'name', this.value)">
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-secondary text-white border-0">æ¬Šé‡(%)</span>
                            <input type="number" class="form-control bg-dark text-white border-secondary text-center" 
                                value="${item.weight !== 0 ? item.weight : ''}" min="0" max="100" placeholder="0"
                                onchange="updateCalcItem(${idx}, 'weight', this.value)">
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-secondary text-white border-0">é€²åº¦(%)</span>
                            <input type="number" class="form-control bg-dark text-white border-secondary text-center" 
                                value="${item.progress !== 0 ? item.progress : ''}" min="0" max="100" placeholder="0"
                                onchange="updateCalcItem(${idx}, 'progress', this.value)">
                        </div>
                    </div>
                </div>
             `;
            list.appendChild(row);
        });

        // Update Footer
        document.getElementById('calcTotalWeight').innerText = totalWeight;
        document.getElementById('calcResult').innerText = totalProg.toFixed(1);

        const warn = document.getElementById('calcWeightWarning');
        // Show warning if NOT 100 (allow small float error)
        const isFull = Math.abs(totalWeight - 100) < 0.1;

        if (!isFull) {
            warn.style.display = 'inline';
            warn.innerText = totalWeight < 100 ? "(ä¸è¶³ 100%)" : "(è¶…é 100%)";
            warn.className = totalWeight < 100 ? "ms-2 text-warning small" : "ms-2 text-danger small";
        } else {
            warn.style.display = 'none';
        }

        // Update Visual Weight Bar
        const bar = document.getElementById('calcWeightBar');
        if (bar) {
            bar.style.width = Math.min(totalWeight, 100) + "%";
            bar.className = 'calc-weight-bar-fill';
            if (totalWeight > 100) bar.classList.add('over');
            else if (totalWeight < 100) bar.classList.add('under');
            else bar.classList.add('exact');
        }
    }

    function addCalcItem() {
        if (!g_calcData.items) g_calcData.items = [];
        g_calcData.items.push({ name: "", weight: 0, progress: 0 });
        renderCalcItems();
    }

    function removeCalcItem(idx) {
        g_calcData.items.splice(idx, 1);
        renderCalcItems();
    }

    function updateCalcItem(idx, field, val) {
        if (field === 'weight' || field === 'progress') {
            g_calcData.items[idx][field] = parseFloat(val) || 0;
        } else {
            g_calcData.items[idx][field] = val;
        }
        renderCalcItems(); // Re-calc total
    }

    function updateCalcMemo(val) {
        g_calcData.memo = val;
    }

    function applyCalcResult() {
        const totalVal = parseFloat(document.getElementById('calcResult').innerText);
        const pid = document.getElementById('projectSelect').value;

        // 1. Update Input
        const inp = document.getElementById('inp_' + g_currentCalcTask);
        if (inp) {
            inp.value = Math.round(totalVal);
            onProgressChange(g_currentCalcTask, Math.round(totalVal));
        }

        // 2. Save Breakdown to Backend
        google.script.run.saveTaskBreakdown(pid, g_currentCalcTask, JSON.stringify(g_calcData));

        // Close Modal
        const el = document.getElementById('calcModal');
        const modal = bootstrap.Modal.getInstance(el);
        modal.hide();
    }
    function showError(msg) {
        const block = document.getElementById('errorBlock');
        block.innerText = msg;
        block.classList.remove('d-none');
        document.getElementById('userInfoBlock').classList.add('d-none');
    }

    function onFailure(error) {
        debugLog("Init Fatal Error: " + (error.message || error));
        showError("åˆå§‹åŒ–å¤±æ•—: " + (error.message || error));
    }

    function closeAppWindow() {
        if (typeof liff !== 'undefined' && liff.isInClient()) {
            liff.closeWindow();
        } else {
            window.close();
        }
    }

    function showSuccessUI(msg) {
        const formContainer = document.getElementById('formBlock');
        const userInfoBlock = document.getElementById('userInfoBlock');
        const statusBar = document.getElementById('status-bar');

        // Hide Form Elements
        formContainer.classList.add('d-none');
        userInfoBlock.classList.add('d-none');
        if (statusBar) statusBar.style.display = 'none';

        // New: Hide Tabs and Edit Selector
        const tabs = document.getElementById('modeTabs');
        const editSelector = document.getElementById('edit-selector-container');
        if (tabs) tabs.style.display = 'none';
        if (editSelector) editSelector.style.display = 'none';

        const successBlock = document.getElementById('successBlock');
        successBlock.classList.remove('d-none');
        document.getElementById('successMsg').innerText = msg || 'è™•ç†æˆåŠŸ';

        // Close Logic
        if (isLineClient) {
            setTimeout(closeAppWindow, 3000);
        }
    }

    function handleBulletinSubmit() {
        const btn = document.getElementById('submitBtn');

        debugLog("Btn Clicked. Mode=" + currentMode);

        // 0. Auth Check
        let uid = document.getElementById('lineUserId').value;
        if (!uid) uid = g_currentUserId;

        if (!uid) {
            debugLog("Auth Fail: No UID found.");
            alert("âš ï¸ èº«åˆ†å°šæœªé©—è­‰ (No UID)\\nè«‹å˜—è©¦é‡æ–°æ•´ç†æˆ–é‡æ–°é–‹å•Ÿé€£çµã€‚");
            return;
        }
        debugLog("Auth OK. UID: " + uid);

        // 1. Content Check
        const contentInput = document.getElementById('contentInput');
        if (!contentInput.value.trim()) {
            alert('è«‹è¼¸å…¥å…§å®¹');
            contentInput.focus();
            return;
        }

        // 2. Disable Button Immediately
        btn.disabled = true;
        btn.innerText = "è™•ç†ä¸­...";
        updateStatus("ğŸš€ æ­£åœ¨é€å‡ºè«‹æ±‚...");

        try {
            let contentVal = document.getElementById('contentInput').value;
            const taskVal = document.getElementById('taskSelect').value;

            // NEW: Check Mode
            const mode = currentMode;
            const uuid = document.getElementById('uuid').value;
            debugLog("Prepare Submit. Mode=" + mode + ", UUID=" + uuid);

            const data = {
                projectId: document.getElementById('projectSelect').value,
                date: document.getElementById('dateInput').value,
                type: document.getElementById('typeSelect').value,
                category: document.getElementById('categorySelect').value,
                item: taskVal || '',
                content: contentVal,
                lineUserId: uid
            };

            // Clean data
            if (data.type !== 'é€²åº¦å›å ±') {
                data.category = '';
                data.item = '';
            }

            if (typeof google === 'undefined' || !google.script) {
                throw new Error("Google Script API not loaded.");
            }

            // Branch Logic for Edit vs New
            if (mode === 'edit') {
                if (!uuid) {
                    alert("éŒ¯èª¤ï¼šæ²’æœ‰é¸æ“‡ä¿®æ”¹çš„é …ç›® (UUID Missing)");
                    btn.disabled = false; btn.innerText = "ç¢ºèªä¿®æ”¹";
                    return;
                }
                data.uuid = uuid;

                debugLog("Invoking updateBulletin...");
                google.script.run
                    .withSuccessHandler(resStr => {
                        debugLog("Update Result: " + resStr);
                        let res;
                        try { res = JSON.parse(resStr); } catch (e) { res = { success: false, message: "JSON Error" }; }

                        if (res.success) {
                            showSuccessUI("ä¿®æ”¹æˆåŠŸ");
                        } else {
                            alert("ä¿®æ”¹å¤±æ•—: " + res.message);
                            btn.disabled = false; btn.innerText = "ç¢ºèªä¿®æ”¹";
                        }
                    })
                    .withFailureHandler(handleFail)
                    .updateBulletin(data);

            } else {
                // New Post
                debugLog("Invoking submitBulletin...");
                google.script.run
                    .withSuccessHandler(res => {
                        debugLog("Submit Success: " + res);
                        showSuccessUI(res);
                    })
                    .withFailureHandler(handleFail)
                    .submitBulletin(data);
            }

            function handleFail(err) {
                console.error("Failure Handler:", err);
                debugLog("Failure: " + err.message);
                alert("å¤±æ•— (å¾Œç«¯æ‹’çµ•)ï¼š\\n" + (err.message || err));
                btn.disabled = false; btn.innerText = (mode === 'edit') ? "ç¢ºèªä¿®æ”¹" : "ç™¼ä½ˆ";
            }


        } catch (ex) {
            console.error("JS Error:", ex);
            debugLog("Catch Error: " + ex.message);
            alert("ç¨‹åºéŒ¯èª¤ (å‰ç«¯)ï¼š\\n" + ex.message);
            btn.disabled = false; btn.innerText = (currentMode === 'edit') ? "ç¢ºèªä¿®æ”¹" : "ç™¼ä½ˆ";
        }
    }

    function setupFormLogic() {
        const typeSelect = document.getElementById('typeSelect');

        // Handle Type Change
        const newTypeSelect = typeSelect.cloneNode(true);
        typeSelect.parentNode.replaceChild(newTypeSelect, typeSelect);

        newTypeSelect.addEventListener('change', function () {
            const cb = document.getElementById('catBlock');
            const tb = document.getElementById('taskBlock');

            if (this.value === 'é€²åº¦å›å ±') {
                if (cb) cb.classList.remove('d-none');
                if (tb) tb.classList.remove('d-none');
                renderTaskOptions();
            } else {
                if (cb) cb.classList.add('d-none');
                if (tb) tb.classList.add('d-none');
            }
        });

        // Bind Category Change
        const catSelect = document.getElementById('categorySelect');
        if (catSelect) {
            const newCatSelect = catSelect.cloneNode(true);
            catSelect.parentNode.replaceChild(newCatSelect, catSelect);
            newCatSelect.addEventListener('change', function () {
                renderTaskOptions();
            });
        }

        // Bind Click to Button
        const btn = document.getElementById('submitBtn');
        btn.onclick = handleBulletinSubmit;

        // Init state
        newTypeSelect.dispatchEvent(new Event('change'));
    }

    // Explicit Global Exposure
    window.handleBulletinSubmit = handleBulletinSubmit;
    window.confirmDelete = confirmDelete;
    window.executeDelete = executeDelete;
</script>